#!/usr/bin/env bash

APP_NAME="$1"

if [ -z "$APP_NAME" ]; then
  echo "Error: No application name provided. Please specify a program name (e.g., 'imv')"
  exit 1
fi

# 1. Find the .desktop file
# We check user local apps first, then system apps.
DESKTOP_FILE=$(find "$HOME/.local/share/applications" "/usr/share/applications" -name "*${APP_NAME}*.desktop" 2>/dev/null | head -n 1)

if [ -z "$DESKTOP_FILE" ]; then
  echo "Error: No .desktop file found for '${APP_NAME}'. Please verify the application name."
  exit 1
fi

REAL_NAME=$(basename "$DESKTOP_FILE")

echo "Found desktop file: $DESKTOP_FILE"

# 2. Extract MimeTypes
# Grep MimeType line, cut after =, replace semicolons with newlines, remove empty lines.
MIME_TYPES=$(grep "^MimeType=" "$DESKTOP_FILE" | cut -d'=' -f2 | tr ';' '\n' | grep -v "^$")

if [ -z "$MIME_TYPES" ]; then
  echo "This application defines no MimeTypes. Cannot proceed with file association."
  exit 1
fi

# 3. Interactive Selection (Exclude/Include)
echo "Initiating MIME type selection process..."
echo "Use TAB to toggle selection. Selected items will be assigned to $REAL_NAME."

# We use fzf to let the user deselect items.
# --bind 'start:select-all' selects everything initially, so the user just deselects what they don't want.
SELECTED_MIMES=$(echo "$MIME_TYPES" | fzf --multi --layout=reverse --header="Select MIME types for $REAL_NAME (TAB to toggle, ENTER to confirm)" --bind 'start:select-all')

if [ -z "$SELECTED_MIMES" ]; then
  echo "No MIME types selected. Operation cancelled."
  exit 0
fi

# 4. Apply changes
COUNT=0
for mime in $SELECTED_MIMES; do
  xdg-mime default "$REAL_NAME" "$mime"
  echo "Associated $mime -> $REAL_NAME"
  ((COUNT++))
done

echo "Operation completed successfully. Updated $COUNT file associations."
